<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WPPConnect Session Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            min-height: 100vh;
            color: white;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px rgba(255, 255, 255, 0.1) solid;
            border-radius: 1.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .pulse-green {
            background-color: #10b981;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="mb-12 text-center">
            <h1
                class="text-4xl md:text-5xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">
                WPPConnect Manager
            </h1>
            <p class="text-slate-400">Khởi tạo và kết nối WhatsApp Session của bạn</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Cấu hình -->
            <div class="glass p-8">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <span class="mr-2">⚙️</span> Cấu hình Server
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Base URL</label>
                        <input type="text" id="baseUrl" value="{{ config.wpp_base_url }}"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 px-4 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Session Name</label>
                        <input type="text" id="sessionName" value="{{ config.wpp_session }}"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 px-4 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Secret Key (Token)</label>
                        <input type="password" id="secretKey" value="{{ config.wpp_secret_key }}"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 px-4 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <button onclick="saveConfig()"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 transition-colors py-2 rounded-lg font-semibold mt-4">
                        Lưu Cấu Hình
                    </button>
                    <button onclick="startSession()"
                        class="w-full bg-blue-600 hover:bg-blue-700 transition-colors py-2 rounded-lg font-semibold">
                        Khởi Tạo Session
                    </button>
                </div>
            </div>

            <!-- Trạng thái & QR -->
            <div class="glass p-8 flex flex-col items-center justify-center text-center">
                <div id="statusArea" class="mb-6">
                    <span id="statusDot" class="status-dot bg-slate-500"></span>
                    <span id="statusText" class="ml-2 font-medium text-slate-300">Đang kiểm tra...</span>
                </div>

                <div id="qrContainer" class="bg-white p-4 rounded-xl hidden">
                    <img id="qrImage" src="" alt="QR Code" class="w-48 h-48">
                </div>

                <div id="loadingPlaceholder"
                    class="w-48 h-48 bg-slate-800 rounded-xl flex items-center justify-center text-slate-500 italic">
                    Chưa có mã QR
                </div>

                <p id="instruction" class="mt-6 text-sm text-slate-400">
                    Nhập thông tin và nhấn "Khởi Tạo" để lấy mã QR
                </p>
            </div>
        </div>
    </div>

    <script>
        let pollingInterval = null;

        async function saveConfig() {
            const data = {
                wpp_base_url: document.getElementById('baseUrl').value,
                wpp_session: document.getElementById('sessionName').value,
                wpp_secret_key: document.getElementById('secretKey').value
            };
            await fetch('/api/save-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            alert('Đã lưu cấu hình!');
        }

        async function startSession() {
            const session = document.getElementById('sessionName').value;
            const base_url = document.getElementById('baseUrl').value;
            const secret_key = document.getElementById('secretKey').value;

            // Reset UI for restart
            document.getElementById('statusText').innerText = 'Đang khởi tạo...';
            document.getElementById('qrContainer').classList.add('hidden');
            document.getElementById('loadingPlaceholder').classList.remove('hidden');
            document.getElementById('loadingPlaceholder').innerText = 'Đang tạo mã QR...';

            const response = await fetch('/api/session/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session, base_url, secret_key })
            });

            const result = await response.json();
            console.log('Start Result:', result);

            startPollingStatus();
        }

        function startPollingStatus() {
            if (pollingInterval) clearInterval(pollingInterval);
            poll();
            pollingInterval = setInterval(poll, 3000);
        }

        async function poll() {
            const session = document.getElementById('sessionName').value;
            const base_url = document.getElementById('baseUrl').value;
            const secret_key = document.getElementById('secretKey').value;
            const timestamp = new Date().getTime();

            try {
                // Check Status with cache-busting
                const statusRes = await fetch(`/api/session/status?session=${session}&base_url=${base_url}&secret_key=${secret_key}&t=${timestamp}`);
                const statusData = await statusRes.json();

                const statusText = document.getElementById('statusText');
                const statusDot = document.getElementById('statusDot');
                const qrContainer = document.getElementById('qrContainer');
                const placeholder = document.getElementById('loadingPlaceholder');
                const instruction = document.getElementById('instruction');

                if (statusData.status === 'CONNECTED' || statusData.state === 'CONNECTED') {
                    statusText.innerText = 'Đã Kết Nối';
                    statusText.className = 'ml-2 font-medium text-emerald-400';
                    statusDot.className = 'status-dot pulse-green';
                    qrContainer.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                    placeholder.innerText = '✓ Đã Kết Nối';
                    instruction.innerText = 'Tài khoản của bạn đã sẵn sàng!';
                    clearInterval(pollingInterval);
                } else {
                    statusText.innerText = 'Đang chờ quét mã...';
                    statusDot.className = 'status-dot bg-yellow-500';

                    // Fetch QR
                    const qrRes = await fetch(`/api/session/qr?session=${session}&base_url=${base_url}&secret_key=${secret_key}`);
                    const qrData = await qrRes.json();

                    if (qrData.qrcode || qrData.base64) {
                        const qrSrc = qrData.base64 || qrData.qrcode;
                        document.getElementById('qrImage').src = qrSrc;
                        qrContainer.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        instruction.innerText = 'Hãy quét mã QR bằng WhatsApp trên điện thoại';
                    }
                }
            } catch (e) {
                console.error('Polling error:', e);
            }
        }
    </script>
</body>

</html>